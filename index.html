<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Phrases Helper</title>
    
    <!-- Apple Touch Icons (iOS) -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon.png">
    
    <!-- For older iOS -->
    <link rel="apple-touch-icon-precomposed" href="icon.png">
    
    <!-- Favicon for browsers -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#4A6FA5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="French Phrases">
    
    <!-- For Microsoft -->
    <meta name="msapplication-TileColor" content="#4A6FA5">
    <meta name="msapplication-TileImage" content="icon.png">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 15px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 18px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4A6FA5 0%, #2E5987 100%); color: white; padding: 22px 18px; text-align: center; }
        h1 { font-size: 24px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .header p { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        .content-area { padding: 20px; }
        h2 { font-size: 19px; color: #2C3E50; margin-bottom: 16px; font-weight: 600; }
        h3 { font-size: 16px; color: #4A6FA5; margin-bottom: 12px; font-weight: 600; }
        .phrase-sets { margin-bottom: 25px; padding: 18px; background: #f8f9ff; border-radius: 14px; border: 2px solid #E0E7FF; }
        .preset-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 600px) { .preset-buttons { grid-template-columns: repeat(3, 1fr); } }
        .preset-btn { padding: 14px 10px; background: white; border: 2px solid #E0E7FF; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; color: #4A6FA5; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 48px; }
        .preset-btn:active { transform: scale(0.98); }
        .preset-btn.active { background: #4A6FA5; color: white; border-color: #4A6FA5; }
        textarea { width: 100%; height: 140px; padding: 18px; font-size: 16px; border: 2px solid #E0E7FF; border-radius: 12px; margin: 18px 0; font-family: inherit; resize: vertical; background: #fdfdfe; }
        .button-row { display: flex; gap: 12px; margin-bottom: 22px; flex-wrap: wrap; }
        .button-row button { flex: 1; min-width: calc(50% - 6px); padding: 16px; background: #4A6FA5; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .button-row button:active { transform: scale(0.98); }
        .clear-btn { background: #F44336; }
        .button-row button:disabled { opacity: 0.6; cursor: not-allowed; }
        .section-divider { border-top: 2px solid #E0E7FF; margin: 28px 0; padding-top: 20px; }
        .phrases-container { margin-top: 25px; }
        .status-bar { background: #E3F2FD; padding: 12px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-size: 14px; color: #4A6FA5; font-weight: 500; }
        .status-bar.offline { background: #FFF3E0; color: #F57C00; }
        .phrase-card { background: white; border: 2px solid #E0E7FF; border-radius: 14px; padding: 22px; margin-bottom: 18px; transition: all 0.3s; position: relative; }
        .phrase-card.speaking { background: #E8F5E9; border-color: #4CAF50; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .french-text { font-size: 22px; color: #2C3E50; text-align: center; margin-bottom: 10px; font-weight: 600; line-height: 1.3; }
        .phrase-card.speaking .french-text { color: #2E7D32; }
        .english-text { font-size: 16px; color: #7f8c8d; text-align: center; font-style: italic; min-height: 22px; transition: all 0.3s; line-height: 1.4; }
        .phrase-card.has-translation .english-text { color: #4A6FA5; font-weight: 500; }
        .buttons-row { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
        .speak-btn, .translate-btn { padding: 14px 20px; border-radius: 10px; color: white; border: none; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; transition: all 0.2s; min-height: 50px; }
        .speak-btn { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); }
        .translate-btn { background: linear-gradient(135deg, #FF9800 0%, #EF6C00 100%); }
        .translate-btn.translating { background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%); }
        .speak-btn:active, .translate-btn:active { transform: scale(0.98); }
        .speak-btn:disabled, .translate-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .speaking-indicator { display: none; justify-content: center; align-items: center; margin-top: 15px; color: #4CAF50; font-weight: 500; gap: 8px; font-size: 14px; }
        .phrase-card.speaking .speaking-indicator { display: flex; }
        .pulse-dot { width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .empty-state { text-align: center; color: #7f8c8d; padding: 40px 20px; font-size: 15px; line-height: 1.5; }
        .confidence-badge { position: absolute; top: 10px; right: 10px; background: #E8F5E9; color: #2E7D32; padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .install-btn { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); margin: 10px auto; display: block; }
        .bulk-save-btn { background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%); }
        .share-btn { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); }
        .progress-bar { width: 100%; height: 8px; background: #E0E7FF; border-radius: 4px; margin: 10px 0; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%); width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; font-size: 14px; color: #4A6FA5; margin-bottom: 10px; display: none; }
        
        /* Share modal styles */
        .share-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .share-content { background: white; padding: 25px; border-radius: 18px; max-width: 500px; width: 90%; text-align: center; }
        .share-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .share-option { padding: 18px; border: 2px solid #E0E7FF; border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .share-option:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .share-option i { font-size: 32px; }
        .share-option span { font-size: 14px; font-weight: 600; color: #4A6FA5; }
        .share-url { background: #f5f7fa; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 14px; word-break: break-all; }
        .close-share { margin-top: 20px; padding: 12px 30px; background: #4A6FA5; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .qr-code { margin: 20px auto; max-width: 200px; }
        
        @media (max-width: 480px) { 
            .buttons-row { flex-direction: column; } 
            .french-text { font-size: 20px; }
            .share-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span>üá´üá∑</span>French Phrases Helper<span>üá¨üáß</span></h1>
            <p>Tap green for French ‚Ä¢ Tap orange for English</p>
        </div>
        <div class="content-area">
            <div id="statusBar" class="status-bar"></div>
            
            <!-- Top action buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button id="installButton" class="install-btn" style="display: none; padding: 12px 20px; border-radius: 10px; color: white; border: none; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; flex: 1; min-width: 140px;">
                    <span>üì±</span> Install App
                </button>
                
                <button id="shareButton" class="share-btn" onclick="openShareModal()" style="padding: 12px 20px; border-radius: 10px; color: white; border: none; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; flex: 1; min-width: 140px;">
                    <span>üì§</span> Share App
                </button>
            </div>
            
            <!-- Progress indicator for bulk translation -->
            <div id="progressText" class="progress-text"></div>
            <div id="progressBar" class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div class="phrase-sets">
                <h3>üìö Quick Practice Sets:</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadPreset(event, 'greetings')">üëã Greetings</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'classroom')">üè´ Classroom</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'numbers')">üî¢ Numbers</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'colors')">üé® Colors</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'days')">üìÖ Days</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'months')">üóìÔ∏è Months</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'alphabet')">üî§ Alphabet</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'family')">üë®‚Äçüë©‚Äçüëß Family</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'food')">üçé Food</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'animals')">üê∂ Animals</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'weather')">‚òÄÔ∏è Weather</button>
                    <button class="preset-btn" onclick="loadPreset(event, 'feelings')">üòä Feelings</button>
                </div>
            </div>
            <div class="section-divider">
                <h2>üìù This Week's Assignment:</h2>
                <textarea id="phrasesInput" placeholder="Enter phrases from your teacher here (one per line)...

Example:
Bonjour, comment √ßa va ?
Je m'appelle Marie.
J'ai six ans."></textarea>
                <div class="button-row">
                    <button id="saveBtn" onclick="savePhrases()"><span>üíæ</span>Save Assignment</button>
                    <button class="clear-btn" onclick="clearPhrases()"><span>üóëÔ∏è</span>Clear</button>
                    <button class="bulk-save-btn" onclick="translateAllPhrases()" id="translateAllBtn">
                        <span>üåê</span>Translate & Save All
                    </button>
                </div>
            </div>
            <div class="phrases-container">
                <h2>Practice:</h2>
                <div id="phrasesList"></div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="shareModal" class="share-modal">
        <div class="share-content">
            <h2 style="color: #4A6FA5; margin-bottom: 15px;">üì§ Share French Phrases Helper</h2>
            <p style="color: #666; margin-bottom: 25px;">Share this app with friends, classmates, or teachers</p>
            
            <div class="share-options">
                <div class="share-option" onclick="shareViaURL()">
                    <span style="font-size: 28px;">üîó</span>
                    <span>Copy Link</span>
                </div>
                
                <div class="share-option" onclick="shareViaQR()">
                    <span style="font-size: 28px;">üì±</span>
                    <span>QR Code</span>
                </div>
                
                <div class="share-option" onclick="shareViaWhatsApp()">
                    <span style="font-size: 28px;">üí¨</span>
                    <span>WhatsApp</span>
                </div>
                
                <div class="share-option" onclick="shareViaEmail()">
                    <span style="font-size: 28px;">üìß</span>
                    <span>Email</span>
                </div>
            </div>
            
            <div id="shareUrlDisplay" class="share-url" style="display: none;">
                <div style="font-weight: 600; margin-bottom: 5px;">Copy this URL:</div>
                <div id="currentUrl"></div>
                <button onclick="copyURL()" style="margin-top: 10px; padding: 8px 15px; background: #4A6FA5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    üìã Copy to Clipboard
                </button>
            </div>
            
            <div id="qrCodeDisplay" class="qr-code" style="display: none;"></div>
            
            <div style="margin-top: 20px; font-size: 13px; color: #888; text-align: left;">
                <p><strong>üí° Sharing Tips:</strong></p>
                <p>‚Ä¢ Send to classmates for group practice</p>
                <p>‚Ä¢ Share with teachers to distribute assignments</p>
                <p>‚Ä¢ Bookmark on school computers/devices</p>
            </div>
            
            <button class="close-share" onclick="closeShareModal()">Close</button>
        </div>
    </div>
    
    <script>
// DOM Elements
const inp = document.getElementById('phrasesInput'),
      lst = document.getElementById('phrasesList'),
      sb = document.getElementById('statusBar'),
      installButton = document.getElementById('installButton'),
      translateAllBtn = document.getElementById('translateAllBtn'),
      progressText = document.getElementById('progressText'),
      progressBar = document.getElementById('progressBar'),
      progressFill = document.getElementById('progressFill'),
      shareModal = document.getElementById('shareModal'),
      shareUrlDisplay = document.getElementById('shareUrlDisplay'),
      qrCodeDisplay = document.getElementById('qrCodeDisplay'),
      currentUrlElement = document.getElementById('currentUrl');

// Data
const sets = {
    greetings: ["Bonjour", "Bonjour, comment √ßa va ?", "√áa va bien, merci", "Et toi ?", "Merci beaucoup", "De rien", "S'il te pla√Æt", "Excusez-moi", "Au revoir", "√Ä bient√¥t", "√Ä demain", "Bonne journ√©e"],
    classroom: ["Je vais √† l'√©cole", "J'aime l'√©cole", "Mon professeur", "Mon ami", "Mon amie", "La r√©cr√©ation", "La cantine", "La salle de classe", "O√π sont les toilettes ?", "La biblioth√®que", "Un crayon", "Un livre", "Un cahier"],
    numbers: ["Un", "Deux", "Trois", "Quatre", "Cinq", "Six", "Sept", "Huit", "Neuf", "Dix", "Onze", "Douze", "Treize", "Quatorze", "Quinze", "Seize", "Dix-sept", "Dix-huit", "Dix-neuf", "Vingt"],
    colors: ["Rouge", "Bleu", "Vert", "Jaune", "Noir", "Blanc", "Rose", "Violet", "Orange", "Marron", "Gris"],
    days: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche", "Aujourd'hui", "Demain", "Hier"],
    months: ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"],
    alphabet: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"],
    family: ["Maman", "Papa", "Mon fr√®re", "Ma s≈ìur", "Grand-m√®re", "Grand-p√®re", "Ma famille", "J'aime ma famille"],
    food: ["Une pomme", "Une banane", "Du pain", "Du fromage", "Du lait", "De l'eau", "Un croissant", "Une pizza", "Des frites", "Un g√¢teau", "Une glace"],
    animals: ["Un chat", "Un chien", "Un oiseau", "Un poisson", "Un cheval", "Une vache", "Un mouton", "Un lapin", "Un lion"],
    weather: ["Il fait beau", "Il pleut", "Il neige", "Il fait chaud", "Il fait froid", "Il y a du vent", "Il y a du soleil"],
    feelings: ["Je suis content", "Je suis contente", "Je suis triste", "Je suis fatigu√©", "Je suis fatigu√©e", "Je suis malade", "J'ai faim", "J'ai soif"]
};

const dict = {
    "bonjour": "Hello",
    "bonjour, comment √ßa va ?": "Hello, how are you?",
    "bonjour, comment ca va ?": "Hello, how are you?",
    "√ßa va bien, merci": "I'm fine, thank you",
    "ca va bien, merci": "I'm fine, thank you",
    "et toi ?": "And you?",
    "et toi": "And you",
    "merci beaucoup": "Thank you very much",
    "merci": "Thank you",
    "de rien": "You're welcome",
    "s'il te pla√Æt": "Please",
    "s'il te plait": "Please",
    "excusez-moi": "Excuse me",
    "au revoir": "Goodbye",
    "√† bient√¥t": "See you soon",
    "a bientot": "See you soon",
    "√† demain": "See you tomorrow",
    "a demain": "See you tomorrow",
    "bonne journ√©e": "Have a good day",
    "bonne journee": "Have a good day",
    "je vais √† l'√©cole": "I go to school",
    "je vais a l'ecole": "I go to school",
    "j'aime l'√©cole": "I like school",
    "j'aime l'ecole": "I like school",
    "mon professeur": "My teacher",
    "mon ami": "My friend (boy)",
    "mon amie": "My friend (girl)",
    "la r√©cr√©ation": "Recess",
    "la recreation": "Recess",
    "la cantine": "Cafeteria",
    "la salle de classe": "Classroom",
    "o√π sont les toilettes ?": "Where is the bathroom?",
    "ou sont les toilettes ?": "Where is the bathroom?",
    "la biblioth√®que": "Library",
    "la bibliotheque": "Library",
    "un crayon": "A pencil",
    "un livre": "A book",
    "un cahier": "A notebook",
    "un": "one", "deux": "two", "trois": "three", "quatre": "four", "cinq": "five",
    "six": "six", "sept": "seven", "huit": "eight", "neuf": "nine", "dix": "ten",
    "onze": "eleven", "douze": "twelve", "treize": "thirteen", "quatorze": "fourteen",
    "quinze": "fifteen", "seize": "sixteen", "dix-sept": "seventeen", "dix-huit": "eighteen",
    "dix-neuf": "nineteen", "vingt": "twenty",
    "rouge": "red", "bleu": "blue", "vert": "green", "jaune": "yellow", "noir": "black",
    "blanc": "white", "rose": "pink", "violet": "purple", "orange": "orange", "marron": "brown",
    "gris": "gray",
    "lundi": "Monday", "mardi": "Tuesday", "mercredi": "Wednesday", "jeudi": "Thursday",
    "vendredi": "Friday", "samedi": "Saturday", "dimanche": "Sunday",
    "aujourd'hui": "today", "aujourd hui": "today", "demain": "tomorrow", "hier": "yesterday",
    "janvier": "January", "f√©vrier": "February", "fevrier": "February", "mars": "March",
    "avril": "April", "mai": "May", "juin": "June", "juillet": "July",
    "ao√ªt": "August", "aout": "August", "septembre": "September", "octobre": "October",
    "novembre": "November", "d√©cembre": "December", "decembre": "December",
    "a": "A", "b": "B", "c": "C", "d": "D", "e": "E", "f": "F", "g": "G", "h": "H",
    "i": "I", "j": "J", "k": "K", "l": "L", "m": "M", "n": "N", "o": "O", "p": "P",
    "q": "Q", "r": "R", "s": "S", "t": "T", "u": "U", "v": "V", "w": "W", "x": "X",
    "y": "Y", "z": "Z",
    "maman": "mom", "papa": "dad", "mon fr√®re": "my brother", "mon frere": "my brother",
    "ma s≈ìur": "my sister", "ma soeur": "my sister", "grand-m√®re": "grandmother",
    "grand-mere": "grandmother", "grand-p√®re": "grandfather", "grand-pere": "grandfather",
    "ma famille": "my family", "j'aime ma famille": "I love my family",
    "une pomme": "an apple", "une banane": "a banana", "du pain": "bread",
    "du fromage": "cheese", "du lait": "milk", "de l'eau": "water",
    "un croissant": "a croissant", "une pizza": "a pizza", "des frites": "fries",
    "un g√¢teau": "a cake", "un gateau": "a cake", "une glace": "ice cream",
    "un chat": "a cat", "un chien": "a dog", "un oiseau": "a bird",
    "un poisson": "a fish", "un cheval": "a horse", "une vache": "a cow",
    "un mouton": "a sheep", "un lapin": "a rabbit", "un lion": "a lion",
    "il fait beau": "The weather is nice", "il pleut": "It's raining",
    "il neige": "It's snowing", "il fait chaud": "It's hot",
    "il fait froid": "It's cold", "il y a du vent": "It's windy",
    "il y a du soleil": "It's sunny", "je suis content": "I am happy (boy)",
    "je suis contente": "I am happy (girl)", "je suis triste": "I am sad",
    "je suis fatigu√©": "I am tired (boy)", "je suis fatigue": "I am tired (boy)",
    "je suis fatigu√©e": "I am tired (girl)", "je suis fatiguee": "I am tired (girl)",
    "je suis malade": "I am sick", "j'ai faim": "I'm hungry", "j'ai soif": "I'm thirsty"
};

let cache = {}, cur = null, sp = null;
let deferredPrompt = null;
let isTranslatingAll = false;

// ========== SERVICE WORKER ==========
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swScript = `
            const CACHE_NAME = 'french-helper-v2';
            self.addEventListener('install', event => self.skipWaiting());
            self.addEventListener('activate', event => event.waitUntil(clients.claim()));
            self.addEventListener('fetch', event => event.respondWith(caches.match(event.request).then(response => response || fetch(event.request))));
        `;
        const blob = new Blob([swScript], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(console.error);
    });
}

// ========== SHARE FUNCTIONALITY ==========
function openShareModal() {
    shareModal.style.display = 'flex';
    // Reset displays
    shareUrlDisplay.style.display = 'none';
    qrCodeDisplay.style.display = 'none';
}

function closeShareModal() {
    shareModal.style.display = 'none';
}

// Get current URL (for sharing)
function getAppURL() {
    return window.location.href;
}

// Copy URL to clipboard
function shareViaURL() {
    const url = getAppURL();
    currentUrlElement.textContent = url;
    shareUrlDisplay.style.display = 'block';
    qrCodeDisplay.style.display = 'none';
}

function copyURL() {
    const url = getAppURL();
    navigator.clipboard.writeText(url).then(() => {
        alert('‚úÖ URL copied to clipboard!\n\nShare this link with others:\n' + url);
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('‚úÖ URL copied to clipboard!');
    });
}

// Generate QR Code
function shareViaQR() {
    const url = getAppURL();
    shareUrlDisplay.style.display = 'none';
    qrCodeDisplay.style.display = 'block';
    
    // Clear previous QR code
    qrCodeDisplay.innerHTML = '';
    
    // Generate QR code using Google Charts API
    const qrSize = 200;
    const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=${qrSize}x${qrSize}&chl=${encodeURIComponent(url)}&choe=UTF-8`;
    
    const qrImg = document.createElement('img');
    qrImg.src = qrUrl;
    qrImg.alt = 'QR Code for French Phrases Helper';
    qrImg.style.width = '100%';
    qrImg.style.height = 'auto';
    qrImg.style.borderRadius = '10px';
    qrCodeDisplay.appendChild(qrImg);
    
    // Add download button
    const downloadBtn = document.createElement('button');
    downloadBtn.innerHTML = 'üì• Download QR Code';
    downloadBtn.style.marginTop = '10px';
    downloadBtn.style.padding = '8px 15px';
    downloadBtn.style.background = '#4CAF50';
    downloadBtn.style.color = 'white';
    downloadBtn.style.border = 'none';
    downloadBtn.style.borderRadius = '5px';
    downloadBtn.style.cursor = 'pointer';
    downloadBtn.onclick = () => downloadQRCode(qrUrl);
    qrCodeDisplay.appendChild(downloadBtn);
}

function downloadQRCode(qrUrl) {
    const link = document.createElement('a');
    link.href = qrUrl;
    link.download = 'french-phrases-helper-qr.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Share via WhatsApp
function shareViaWhatsApp() {
    const url = getAppURL();
    const text = `Check out French Phrases Helper! Learn French with pronunciation and translation. ${url}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
}

// Share via Email
function shareViaEmail() {
    const url = getAppURL();
    const subject = 'French Phrases Helper - Learn French';
    const body = `Hi!

I found this great French learning app that you might like:

üá´üá∑ French Phrases Helper
${url}

Features:
‚Ä¢ Practice French phrases with pronunciation
‚Ä¢ Get instant translations
‚Ä¢ Works offline
‚Ä¢ Can be installed as an app

Perfect for students learning French!

Best regards`;
    
    const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoUrl;
}

// Use Web Share API if available (mobile devices)
function checkWebShareAPI() {
    if (navigator.share) {
        const shareButton = document.getElementById('shareButton');
        shareButton.onclick = async () => {
            try {
                await navigator.share({
                    title: 'French Phrases Helper',
                    text: 'Learn French phrases with pronunciation and translation',
                    url: window.location.href,
                });
                console.log('Shared successfully');
            } catch (err) {
                // User cancelled or error, fallback to modal
                openShareModal();
            }
        };
    }
}

// Check for Web Share API on load
document.addEventListener('DOMContentLoaded', checkWebShareAPI);

// ========== PWA INSTALL PROMPT ==========
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installButton.style.display = 'flex';
    
    installButton.onclick = () => {
        installButton.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            deferredPrompt = null;
        });
    };
});

window.addEventListener('appinstalled', () => {
    installButton.style.display = 'none';
    deferredPrompt = null;
});

// ========== CORE FUNCTIONS ==========
function norm(t) {
    return t.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function getTr(t) {
    const n = norm(t);
    return dict[n] || cache[n] || null;
}

function saveTr(f, e) {
    cache[norm(f)] = e;
    try {
        localStorage.setItem('phraseTranslations', JSON.stringify(cache));
    } catch (err) {
        console.warn('Failed to save translation:', err);
    }
    updSt();
}

async function fetchTr(t) {
    if (!navigator.onLine) return null;
    
    // Try LibreTranslate
    try {
        const r = await fetch('https://libretranslate.com/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ q: t, source: 'fr', target: 'en', format: 'text' })
        });
        if (r.ok) {
            const d = await r.json();
            return d.translatedText;
        }
    } catch (e) {
        console.log('LibreTranslate failed:', e);
    }
    
    // Try MyMemory as fallback
    try {
        const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(t)}&langpair=fr|en`);
        const d = await r.json();
        if (d.responseData?.translatedText) return d.responseData.translatedText;
    } catch (e) {
        console.log('MyMemory failed:', e);
    }
    
    return null;
}

// ========== BULK TRANSLATION FUNCTION ==========
async function translateAllPhrases() {
    if (!navigator.onLine) {
        alert('You need to be online to translate all phrases.');
        return;
    }
    
    if (isTranslatingAll) return;
    
    const cards = document.querySelectorAll('.phrase-card');
    if (cards.length === 0) {
        alert('No phrases to translate. Add some phrases first.');
        return;
    }
    
    // Count phrases that need translation
    let phrasesToTranslate = [];
    cards.forEach(card => {
        const french = card.dataset.french;
        if (!getTr(french)) {
            phrasesToTranslate.push({
                card: card,
                french: french,
                englishText: card.querySelector('.english-text'),
                badge: card.querySelector('.confidence-badge')
            });
        }
    });
    
    if (phrasesToTranslate.length === 0) {
        alert('All phrases already have translations!');
        return;
    }
    
    // Ask for confirmation
    if (!confirm(`Translate ${phrasesToTranslate.length} phrase(s)? This may take a moment.`)) {
        return;
    }
    
    isTranslatingAll = true;
    translateAllBtn.disabled = true;
    translateAllBtn.innerHTML = '<span>‚è≥</span> Translating...';
    
    // Show progress bar
    progressBar.style.display = 'block';
    progressText.style.display = 'block';
    progressFill.style.width = '0%';
    
    let translatedCount = 0;
    let savedCount = 0;
    
    // Process each phrase with delay to avoid API rate limiting
    for (let i = 0; i < phrasesToTranslate.length; i++) {
        const item = phrasesToTranslate[i];
        
        // Update progress
        const progress = Math.round(((i + 1) / phrasesToTranslate.length) * 100);
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Translating... ${i + 1} of ${phrasesToTranslate.length} (${progress}%)`;
        
        // Show which phrase is being translated
        item.card.style.boxShadow = '0 0 0 2px #2196F3';
        item.englishText.textContent = 'Translating...';
        item.englishText.style.color = '#2196F3';
        
        try {
            const translation = await fetchTr(item.french);
            
            if (translation) {
                // Save translation
                saveTr(item.french, translation);
                translatedCount++;
                savedCount++;
                
                // Update UI
                item.englishText.textContent = translation;
                item.englishText.style.color = '#4A6FA5';
                item.card.classList.add('has-translation');
                item.badge.textContent = '‚úì Saved';
                item.badge.style.background = '#E1BEE7';
                item.badge.style.color = '#7B1FA2';
                
                // Flash effect for saved badge
                setTimeout(() => {
                    item.badge.style.background = '#E8F5E9';
                    item.badge.style.color = '#2E7D32';
                    item.badge.textContent = '‚úì Ready';
                    item.card.style.boxShadow = '';
                }, 500);
            } else {
                item.englishText.textContent = 'Translation failed';
                item.englishText.style.color = '#F44336';
                translatedCount++;
            }
        } catch (error) {
            item.englishText.textContent = 'Error';
            item.englishText.style.color = '#F44336';
            console.error('Translation error:', error);
        }
        
        // Small delay between requests to avoid rate limiting
        if (i < phrasesToTranslate.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }
    
    // Hide progress bar
    setTimeout(() => {
        progressBar.style.display = 'none';
        progressText.style.display = 'none';
    }, 1000);
    
    // Update button
    translateAllBtn.disabled = false;
    translateAllBtn.innerHTML = '<span>üåê</span>Translate & Save All';
    isTranslatingAll = false;
    
    // Show results
    alert(`‚úÖ Translation complete!\n\n‚Ä¢ Successfully translated: ${savedCount} phrase(s)\n‚Ä¢ Failed: ${translatedCount - savedCount} phrase(s)\n\nAll translations have been saved for offline use.`);
    
    // Update status
    updSt();
}

// ========== UI FUNCTIONS ==========
document.addEventListener('DOMContentLoaded', () => {
    // Load cached translations
    const s = localStorage.getItem('phraseTranslations');
    if (s) {
        try {
            cache = JSON.parse(s);
        } catch (e) {
            console.warn('Failed to parse cached translations:', e);
        }
    }
    
    // Load saved phrases
    const p = localStorage.getItem('frenchPhrases');
    if (p) {
        inp.value = p;
        updList();
    }
    
    updSt();
    
    // Add input listener for real-time updates
    inp.addEventListener('input', updList);
});

function updSt() {
    const c = Object.keys(cache).length;
    const d = Object.keys(dict).length;
    const t = c + d;
    
    const isOnline = navigator.onLine;
    sb.className = isOnline ? 'status-bar' : 'status-bar offline';
    
    if (isOnline) {
        sb.textContent = `‚úì Online ‚Ä¢ ${t} phrases available offline`;
        document.querySelectorAll('.translate-btn').forEach(btn => {
            btn.disabled = false;
            btn.title = "";
        });
    } else {
        sb.textContent = `üì¥ Offline ‚Ä¢ ${t} cached phrases available`;
        document.querySelectorAll('.translate-btn').forEach(btn => {
            btn.disabled = true;
            btn.title = "Translation requires internet connection";
        });
        translateAllBtn.disabled = true;
    }
}

window.addEventListener('online', updSt);
window.addEventListener('offline', updSt);

function loadPreset(e, n) {
    cur = n;
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    e.currentTarget.classList.add('active');
    disp(sets[n]);
}

function savePhrases() {
    const t = inp.value.trim();
    if (!t) {
        alert('Please enter some phrases first!');
        return;
    }
    try {
        localStorage.setItem('frenchPhrases', t);
        cur = null;
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        updList();
        alert('Assignment saved!');
    } catch (err) {
        alert('Failed to save. Storage might be full.');
    }
}

function clearPhrases() {
    if (confirm('Clear current phrases?')) {
        inp.value = '';
        cur = null;
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        updList();
    }
}

function updList() {
    const t = inp.value;
    const p = t.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    disp(p);
}

function disp(ps) {
    lst.innerHTML = '';
    if (ps.length === 0) {
        lst.innerHTML = '<div class="empty-state"><p>üëÜ Choose a practice set above</p><p>or enter phrases from your teacher!</p></div>';
        return;
    }
    
    ps.forEach((p, i) => {
        const tr = getTr(p);
        const c = document.createElement('div');
        c.className = 'phrase-card';
        c.dataset.index = i;
        c.dataset.french = p;
        if (tr) c.classList.add('has-translation');
        
        const b = document.createElement('div');
        b.className = 'confidence-badge';
        b.textContent = tr ? '‚úì Ready' : '';
        
        const f = document.createElement('div');
        f.className = 'french-text';
        f.textContent = p;
        
        const e = document.createElement('div');
        e.className = 'english-text';
        e.textContent = tr || (navigator.onLine ? 'Tap orange button for translation' : 'Offline - no translation available');
        
        const bs = document.createElement('div');
        bs.className = 'buttons-row';
        
        const sb = document.createElement('button');
        sb.className = 'speak-btn';
        sb.innerHTML = '<span>üîä</span> French';
        sb.onclick = () => spkFr(i);
        sb.disabled = !('speechSynthesis' in window);
        
        const tb = document.createElement('button');
        tb.className = 'translate-btn';
        tb.innerHTML = '<span>üá¨üáß</span> English';
        tb.onclick = () => trSpk(i);
        tb.disabled = !navigator.onLine;
        if (!navigator.onLine) {
            tb.title = "Translation requires internet connection";
        }
        
        const ind = document.createElement('div');
        ind.className = 'speaking-indicator';
        ind.innerHTML = '<div class="pulse-dot"></div><span>Speaking...</span>';
        
        bs.appendChild(sb);
        bs.appendChild(tb);
        c.appendChild(b);
        c.appendChild(f);
        c.appendChild(e);
        c.appendChild(bs);
        c.appendChild(ind);
        lst.appendChild(c);
    });
}

function spkFr(i) {
    if (!('speechSynthesis' in window)) {
        alert('Text-to-speech is not supported in your browser');
        return;
    }
    
    if (speechSynthesis.speaking) return;
    
    const c = document.querySelector(`.phrase-card[data-index="${i}"]`);
    if (!c) return;
    
    const t = c.querySelector('.french-text').textContent;
    if (sp) speechSynthesis.cancel();
    
    document.querySelectorAll('.phrase-card').forEach(x => x.classList.remove('speaking'));
    c.classList.add('speaking');
    
    const u = new SpeechSynthesisUtterance(t);
    u.lang = 'fr-FR';
    u.rate = 0.85;
    u.onend = u.onerror = () => {
        c.classList.remove('speaking');
        sp = null;
    };
    sp = u;
    speechSynthesis.speak(u);
}

async function trSpk(i) {
    const c = document.querySelector(`.phrase-card[data-index="${i}"]`);
    if (!c) return;
    
    const f = c.dataset.french;
    const el = c.querySelector('.english-text');
    const btn = c.querySelector('.translate-btn');
    let tr = getTr(f);
    
    if (!tr) {
        if (!navigator.onLine) {
            el.textContent = 'Offline - no translation available';
            return;
        }
        
        btn.classList.add('translating');
        btn.innerHTML = '<span>‚è≥</span> Translating...';
        btn.disabled = true;
        
        tr = await fetchTr(f);
        if (tr) {
            saveTr(f, tr);
            el.textContent = tr;
            c.classList.add('has-translation');
            const badge = c.querySelector('.confidence-badge');
            badge.textContent = '‚úì Saved';
            badge.style.background = '#E1BEE7';
            badge.style.color = '#7B1FA2';
            
            setTimeout(() => {
                badge.textContent = '‚úì Ready';
                badge.style.background = '#E8F5E9';
                badge.style.color = '#2E7D32';
            }, 1000);
        } else {
            el.textContent = 'Translation failed';
        }
        
        btn.classList.remove('translating');
        btn.innerHTML = '<span>üá¨üáß</span> English';
        btn.disabled = false;
    }
    
    if (tr) spkEn(c, tr);
}

function spkEn(c, t) {
    if (!('speechSynthesis' in window)) {
        alert('Text-to-speech is not supported in your browser');
        return;
    }
    
    if (speechSynthesis.speaking) return;
    if (sp) speechSynthesis.cancel();
    
    document.querySelectorAll('.phrase-card').forEach(x => x.classList.remove('speaking'));
    c.classList.add('speaking');
    
    const u = new SpeechSynthesisUtterance(t);
    u.lang = 'en-US';
    u.rate = 0.9;
    u.onend = u.onerror = () => {
        c.classList.remove('speaking');
        sp = null;
    };
    sp = u;
    speechSynthesis.speak(u);
}

// Clean up speech synthesis on page unload
window.addEventListener('beforeunload', () => {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
});
    </script>
</body>
</html>